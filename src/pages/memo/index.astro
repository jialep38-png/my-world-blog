---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Icon from '../../components/Icon.astro';
import Lightbox from '../../components/Lightbox.astro';
import { getEntry, render } from 'astro:content';

const prod = import.meta.env.PROD;

const entry = await getEntry('memo', 'index');
if (!entry) {
  throw new Error('Missing memo page entry: src/content/memo/index.md');
}
if (prod && entry.data.draft) {
  throw new Error('Memo entry is marked draft...');
}

const { Content, headings } = await render(entry);

// Build TOC by date (newest first) and optional folders.
type TocItem = { text: string; slug: string };
type TocGroup = { title: string; items: TocItem[] };

const rawGroups: TocGroup[] = [];
let current: TocGroup | null = null;
for (const h of headings) {
  if (h.depth === 2) {
    current = { title: h.text, items: [] };
    rawGroups.push(current);
  } else if (h.depth === 3) {
    if (!current) {
      current = { title: '目录', items: [] };
      rawGroups.push(current);
    }
    current.items.push({ text: h.text, slug: h.slug });
  }
}

const groups = rawGroups
  .filter((g) => g.items.length > 0)
  .reverse()
  .map((g) => ({ ...g, items: [...g.items].reverse() }));

const parseDate = (text: string) => {
  const normalized = text.trim();
  const iso = normalized.match(/(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})/);
  if (iso) {
    const [, y, m, d] = iso;
    const date = new Date(Number(y), Number(m) - 1, Number(d));
    if (!Number.isNaN(date.getTime())) {
      return {
        key: date.getTime(),
        label: `${y}年${String(Number(m)).padStart(2, '0')}月${String(Number(d)).padStart(2, '0')}日`
      };
    }
  }

  const cn = normalized.match(/(\d{4})年\s*(\d{1,2})月\s*(\d{1,2})日/);
  if (cn) {
    const [, y, m, d] = cn;
    const date = new Date(Number(y), Number(m) - 1, Number(d));
    if (!Number.isNaN(date.getTime())) {
      return {
        key: date.getTime(),
        label: `${y}年${String(Number(m)).padStart(2, '0')}月${String(Number(d)).padStart(2, '0')}日`
      };
    }
  }

  return null;
};

const allItems = groups.flatMap((g) =>
  g.items.map((it) => {
    const dateFromItem = parseDate(it.text);
    const dateFromGroup = parseDate(g.title);
    const parsed = dateFromItem ?? dateFromGroup;
    return {
      ...it,
      date: parsed?.label ?? g.title,
      sortKey: parsed?.key ?? -Infinity
    };
  })
);

const folders = [
  {
    title: '减肥记录',
    items: allItems
      .filter((it) => it.text.includes('减肥'))
      .sort((a, b) => b.sortKey - a.sortKey)
  }
].filter((folder) => folder.items.length > 0);
---

<BaseLayout
  title="生活小记"
  description="整理一些值得留存的片刻与回忆。"
  bodyClass="memo-page immersive-page"
>
  <div class="page-header reader-exit-anchor">
    <h1 class="page-title">{entry.data.title}</h1>
    {entry.data.subtitle ? <span class="page-subtitle">{entry.data.subtitle}</span> : null}
    <button
      id="reader-exit"
      class="icon-button reader-exit"
      type="button"
      aria-label="退出阅读"
      title="退出阅读"
      aria-hidden="true"
      tabindex="-1"
    >
      <Icon name="reader-exit" class="icon" />
    </button>
  </div>

  <div class="intro">
    时间流经我们，如同风穿过回廊。
    <br />总有一些瞬间，携带着特别的气息或光亮，短暂停留后便消散。
    <br />有些感受，无法被镜头承载，有些记忆难以被影像收藏。
    <br />也许，为瞬间的感受留下一份文字备份，正是抵抗遗忘最温柔却最有效的方式。
  </div>

  <nav class="memo-toc" aria-label="目录">
    {folders.length > 0 && (
      <section class="memo-toc-folders" aria-labelledby="memo-folders-title">
        <h2 id="memo-folders-title" class="memo-toc-folder-title">文件夹</h2>
        {folders.map((folder) => (
          <details>
            <summary>
              <span class="memo-folder-title">{folder.title}</span>
            </summary>
            <ul class="toc-items">
              {folder.items.map((it, i) => (
                <li>
                  <a href={`#${it.slug}`}>
                    <span class="toc-num">{i + 1}</span>
                    <span class="toc-text">{it.date} · {it.text}</span>
                  </a>
                </li>
              ))}
            </ul>
          </details>
        ))}
      </section>
    )}

  </nav>

  <div class="memo-content prose">
    <Content />
  </div>

  <script is:inline>
    (() => {
      const mq = window.matchMedia('(max-width: 640px)');
      const sync = () => {
        if (mq.matches) {
          document.querySelectorAll('.memo-toc details[open]').forEach((el) => {
            el.removeAttribute('open');
          });
        }
      };
      sync();
      mq.addEventListener('change', sync);

      const content = document.querySelector('.memo-content');
      if (content) {
        const nodes = content.querySelectorAll('h2, h3');
        let count = 0;
        nodes.forEach((node) => {
          if (node.tagName === 'H2') {
            count = 0;
            return;
          }
          if (node.tagName === 'H3') {
            count += 1;
            node.setAttribute('data-num', String(count));
          }
        });
      }
    })();
  </script>

  <Lightbox
    id="lightbox"
    label="图片预览"
    enableZoom={false}
    enablePan={false}
    enableSwipeDownClose={false}
  />

  <script>
    import { initArticleLightbox } from '../../scripts/lightbox';

    initArticleLightbox({
      dialogId: 'lightbox',
      containerSelector: '.memo-content.prose',
      enableZoom: false,
      enablePan: false,
      enableSwipeDownClose: false
    });
  </script>
</BaseLayout>
