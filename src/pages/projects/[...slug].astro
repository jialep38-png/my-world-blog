---
import { render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Icon from '../../components/Icon.astro';
import Lightbox from '../../components/Lightbox.astro';
import ArticleToc from '../../components/ArticleToc.astro';
import { getSortedProjects, getProjectSlug, getSortedEssays, getEssaySlug, PROJECT_STATUS_LABELS, type ProjectEntry } from '../../lib/content';
import { createWithBase, formatISODate } from '../../utils/format';
import { getMetaDescription } from '../../utils/excerpt';

interface RelatedEssay {
  slug: string;
  title: string;
  href: string;
}

interface Props {
  entry: ProjectEntry;
  relatedEssays: RelatedEssay[];
}

export async function getStaticPaths() {
  const base = import.meta.env.BASE_URL ?? '/';
  const withBase = createWithBase(base);
  const projects = await getSortedProjects();
  const essays = await getSortedEssays();
  const essayMap = new Map(essays.map((e) => [getEssaySlug(e), e]));

  return projects.map((entry) => {
    const slug = getProjectSlug(entry);
    const relatedEssays = entry.data.relatedEssays
      .map((essaySlug) => {
        const essay = essayMap.get(essaySlug);
        if (!essay) return null;
        return {
          slug: getEssaySlug(essay),
          title: essay.data.title,
          href: withBase(`/archive/${getEssaySlug(essay)}/`)
        };
      })
      .filter((e): e is RelatedEssay => e !== null);

    return {
      params: { slug },
      props: { entry, relatedEssays }
    };
  });
}

const { entry, relatedEssays } = Astro.props;
const { Content, headings } = await render(entry);
const hasToc = headings.some((item: { depth: number }) => item.depth === 2 || item.depth === 3);

const base = import.meta.env.BASE_URL ?? '/';
const withBase = createWithBase(base);

const defaultImage = '/og.svg';
const coverImage = entry?.data?.cover ?? null;
const ogImage = coverImage ?? defaultImage;
const description = getMetaDescription(entry);
---

<BaseLayout
  title={entry.data.title}
  description={description}
  image={ogImage}
  ogType="article"
  bodyClass="article-page immersive-page"
>
  <Fragment slot="head">
    <meta property="article:published_time" content={entry.data.date.toISOString()} />
    {entry.data.tags.map((tag: string) => (
      <meta property="article:tag" content={tag} />
    ))}
  </Fragment>

  <div class="article-header reader-exit-anchor">
    <h1 class="page-title">{entry.data.title}</h1>
    <button
      id="reader-exit"
      class="icon-button reader-exit"
      type="button"
      aria-label="退出阅读"
      title="退出阅读"
      aria-hidden="true"
      tabindex="-1"
    >
      <Icon name="reader-exit" class="icon" />
    </button>
    <div class="meta-line">
      发布于：{formatISODate(entry.data.date)}
      · <span class={`project-status project-status--${entry.data.status}`}>{PROJECT_STATUS_LABELS[entry.data.status]}</span>
      {entry.data.tags[0] ? <> · <span class="tag">#{entry.data.tags[0]}</span></> : null}
    </div>
  </div>

  <div class:list={["article-with-toc", hasToc && "article-with-toc--active"]}>
    <div class="article-main">
      <div class="project-meta">
        {entry.data.stack.length > 0 && (
          <div class="project-stack">
            <span class="project-meta-label">技术栈：</span>
            {entry.data.stack.map((tech: string) => (
              <span class="project-tech">{tech}</span>
            ))}
          </div>
        )}
        {entry.data.links && (
          <div class="project-links">
            {entry.data.links.github && (
              <a href={entry.data.links.github} class="project-link" target="_blank" rel="noopener noreferrer">
                <Icon name="github" size={16} /> GitHub
              </a>
            )}
            {entry.data.links.demo && (
              <a href={entry.data.links.demo} class="project-link" target="_blank" rel="noopener noreferrer">
                <Icon name="link" size={16} /> Demo
              </a>
            )}
          </div>
        )}
      </div>

      <div class="prose">
        <Content />
      </div>

      {relatedEssays.length > 0 && (
        <div class="related-essays">
          <h2 class="related-essays__title">相关文章</h2>
          <ul class="related-essays__list">
            {relatedEssays.map((essay) => (
              <li>
                <a href={essay.href}>{essay.title}</a>
              </li>
            ))}
          </ul>
        </div>
      )}

      <nav class="prev-next" aria-label="返回列表">
        <div class="prev-next__item">
          <a class="prev-next__link prev-next__link--prev" href={withBase('/projects/')}>
            <span class="prev-next__label">返回</span>
            <span class="prev-next__title">项目列表</span>
          </a>
        </div>
      </nav>
    </div>

    <ArticleToc headings={headings} />
  </div>

  <Lightbox
    id="lightbox"
    label="图片预览"
    enableZoom={false}
    enablePan={false}
    enableSwipeDownClose={false}
  />

  <script>
    import { initArticleLightbox } from '../../scripts/lightbox';

    initArticleLightbox({
      dialogId: 'lightbox',
      containerSelector: '.prose',
      enableZoom: false,
      enablePan: false,
      enableSwipeDownClose: false
    });
  </script>
</BaseLayout>

<style>
  .project-status {
    display: inline-flex;
    align-items: center;
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
  }

  .project-status--planned { background: #f3f4f6; color: #6b7280; }
  .project-status--in-progress { background: #dbeafe; color: #1d4ed8; }
  .project-status--shipped { background: #dcfce7; color: #15803d; }
  .project-status--paused { background: #fef3c7; color: #b45309; }
  .project-status--archived { background: #f3f4f6; color: #9ca3af; }

  :root[data-theme="dark"] .project-status--planned { background: #374151; color: #9ca3af; }
  :root[data-theme="dark"] .project-status--in-progress { background: #1e3a5f; color: #60a5fa; }
  :root[data-theme="dark"] .project-status--shipped { background: #14532d; color: #4ade80; }
  :root[data-theme="dark"] .project-status--paused { background: #451a03; color: #fbbf24; }
  :root[data-theme="dark"] .project-status--archived { background: #374151; color: #6b7280; }

  .project-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 24px;
    padding: 16px;
    background: var(--code-content-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
  }

  .project-stack {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .project-meta-label {
    font-size: 13px;
    color: var(--muted);
  }

  .project-tech {
    padding: 2px 8px;
    background: var(--code-header-bg);
    border-radius: 4px;
    font-size: 12px;
    color: var(--muted);
  }

  .project-links {
    display: flex;
    gap: 12px;
    margin-left: auto;
  }

  .project-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--code-header-bg);
    border-radius: 6px;
    font-size: 13px;
    color: var(--text);
    text-decoration: none;
    transition: background 0.2s ease;
  }

  .project-link:hover {
    background: var(--code-action-hover-bg);
  }

  .related-essays {
    margin-top: 48px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }

  .related-essays__title {
    font-size: 18px;
    margin: 0 0 16px;
  }

  .related-essays__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .related-essays__list a {
    color: var(--accent);
    text-decoration: none;
  }

  .related-essays__list a:hover {
    text-decoration: underline;
  }

  @media (max-width: 640px) {
    .project-meta {
      flex-direction: column;
    }

    .project-links {
      margin-left: 0;
    }
  }
</style>
